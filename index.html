<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é›‡ç”¨æ¡ä»¶ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ  Pro</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@stlite/mountable@0.58.0/build/stlite.css">
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        #loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            color: white;
            flex-direction: column;
        }
        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid rgba(255,255,255,0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .loading-text {
            margin-top: 20px;
            font-size: 1.2rem;
        }
        #root {
            min-height: 100vh;
        }
        .fullscreen-tip {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            background: #667eea;
            color: white;
            padding: 10px;
            text-align: center;
            z-index: 1000;
            font-size: 14px;
        }
        .fullscreen-tip button {
            background: white;
            color: #667eea;
            border: none;
            padding: 5px 15px;
            margin-left: 10px;
            border-radius: 5px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div id="loading">
        <div class="spinner"></div>
        <div class="loading-text">ã‚·ã‚¹ãƒ†ãƒ ã‚’èµ·å‹•ã—ã¦ã„ã¾ã™...</div>
        <div style="margin-top: 10px; font-size: 0.9rem; opacity: 0.8;">åˆå›ã¯1åˆ†ç¨‹åº¦ã‹ã‹ã‚Šã¾ã™</div>
    </div>
    <div id="fullscreen-tip" class="fullscreen-tip" style="display:none;">
        ğŸ’¡ ãƒ•ãƒ«ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã§ä½¿ç”¨: Windows: F11 | Mac: Control+Command+F
        <button onclick="document.getElementById('fullscreen-tip').style.display='none'">é–‰ã˜ã‚‹</button>
    </div>
    <div id="root"></div>
    
    <script src="https://cdn.jsdelivr.net/npm/@stlite/mountable@0.58.0/build/stlite.js"></script>
    <script>
        window.addEventListener('load', function() {
            setTimeout(function() {
                try {
                    stlite.mount(
                        {
                            requirements: ["pandas"],
                            entrypoint: "streamlit_app.py",
                            files: {
                                "streamlit_app.py": `
import streamlit as st
import pandas as pd
import json
import time
from datetime import datetime

# ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆé …ç›®å®šç¾©
DEFAULT_FIELDS = [
    {"no": 1, "label": "ä¼æ¥­å", "type": "text", "required": True, "page": 1},
    {"no": 2, "label": "ä¼æ¥­åï¼ˆè‹±èªï¼‰", "type": "text", "required": True, "page": 1},
    {"no": 3, "label": "æ‰€åœ¨åœ°", "type": "text", "required": True, "page": 1},
    {"no": 4, "label": "ä»£è¡¨è€…å", "type": "text", "required": True, "page": 1},
    {"no": 5, "label": "å¾“æ¥­å“¡æ•°", "type": "number", "required": False, "page": 1},
    {"no": 10, "label": "å¥‘ç´„æœŸé–“é–‹å§‹æ—¥", "type": "date", "required": True, "page": 2},
    {"no": 11, "label": "å¥‘ç´„æœŸé–“çµ‚äº†æ—¥", "type": "date", "required": True, "page": 2},
    {"no": 12, "label": "é›‡ç”¨å½¢æ…‹", "type": "select", "required": True, "page": 2, "options": ["æ­£ç¤¾å“¡", "å¥‘ç´„ç¤¾å“¡", "æŠ€èƒ½å®Ÿç¿’ç”Ÿ", "ç‰¹å®šæŠ€èƒ½"]},
    {"no": 13, "label": "å®¿æ³Šæ–½è¨­", "type": "select", "required": True, "page": 2, "options": ["æœªå®š", "ç¢ºå®š", "ä¸è¦"]},
    {"no": 17, "label": "å®¿èˆç·é¢ç©(ã¡)", "type": "number", "required": False, "page": 2},
    {"no": 18, "label": "å±…ä½äººæ•°", "type": "number", "required": False, "page": 2},
    {"no": 20, "label": "å¹´é–“ä¼‘æ—¥", "type": "number", "required": True, "page": 3},
    {"no": 21, "label": "é€±ä¼‘åˆ¶", "type": "select", "required": True, "page": 3, "options": ["å®Œå…¨é€±ä¼‘2æ—¥åˆ¶", "é€±ä¼‘2æ—¥åˆ¶", "é€±ä¼‘1æ—¥åˆ¶"]},
    {"no": 22, "label": "1æ—¥ã®æ‰€å®šåŠ´åƒæ™‚é–“", "type": "number", "required": True, "page": 3},
    {"no": 23, "label": "åŸºæœ¬çµ¦ï¼ˆæœˆé¡ãƒ»å††ï¼‰", "type": "number", "required": True, "page": 3},
    {"no": 24, "label": "éƒ½é“åºœçœŒ", "type": "select", "required": True, "page": 3, "options": ["æ±äº¬éƒ½", "å¤§é˜ªåºœ", "æ„›çŸ¥çœŒ", "ç¥å¥ˆå·çœŒ", "åŸ¼ç‰çœŒ", "åƒè‘‰çœŒ", "ç¦å²¡çœŒ", "åŒ—æµ·é“", "ãã®ä»–"]},
    {"no": 30, "label": "æ®‹æ¥­æ‰‹å½“", "type": "select", "required": True, "page": 4, "options": ["æœ‰ï¼ˆ125%ï¼‰", "æœ‰ï¼ˆ150%ï¼‰", "ç„¡"]},
    {"no": 31, "label": "æ·±å¤œæ‰‹å½“", "type": "select", "required": True, "page": 4, "options": ["æœ‰", "ç„¡"]},
    {"no": 32, "label": "ä¼‘æ—¥æ‰‹å½“", "type": "select", "required": True, "page": 4, "options": ["æœ‰", "ç„¡"]},
]

MIN_WAGE = {"æ±äº¬éƒ½": 1113, "å¤§é˜ªåºœ": 1064, "æ„›çŸ¥çœŒ": 1027, "ç¥å¥ˆå·çœŒ": 1112, "åŸ¼ç‰çœŒ": 1028, "åƒè‘‰çœŒ": 1026, "ç¦å²¡çœŒ": 941, "åŒ—æµ·é“": 960, "ãã®ä»–": 900}

def validate(data, fields):
    errors = []
    warnings = []
    for f in fields:
        fid = str(f["no"])
        val = data.get(fid)
        if f.get("required") and not val:
            errors.append(f"[{fid}] {f['label']} ã¯å¿…é ˆã§ã™")
    
    # æœ€ä½è³ƒé‡‘ãƒã‚§ãƒƒã‚¯
    if data.get("23") and data.get("24") and data.get("22"):
        wage = float(data.get("23", 0))
        pref = data.get("24")
        hours = float(data.get("22", 8))
        min_monthly = MIN_WAGE.get(pref, 900) * hours * 21.67
        if wage < min_monthly:
            warnings.append(f"åŸºæœ¬çµ¦ãŒæœ€ä½è³ƒé‡‘ã‚’ä¸‹å›ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™")
    
    # å¹´é–“ä¼‘æ—¥ãƒã‚§ãƒƒã‚¯
    if data.get("20"):
        if int(data.get("20", 0)) < 105:
            warnings.append("å¹´é–“ä¼‘æ—¥ãŒ105æ—¥æœªæº€ã§ã™")
    
    return errors, warnings

st.set_page_config(page_title="é›‡ç”¨æ¡ä»¶ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ ", page_icon="ğŸ“‹", layout="wide")

if "db" not in st.session_state:
    st.session_state.db = []
if "current_id" not in st.session_state:
    st.session_state.current_id = None
if "fields" not in st.session_state:
    st.session_state.fields = DEFAULT_FIELDS

# ã‚µã‚¤ãƒ‰ãƒãƒ¼
with st.sidebar:
    st.title("ğŸ“‹ é›‡ç”¨æ¡ä»¶ç®¡ç†")
    st.divider()
    
    if st.button("â• æ–°è¦ä½œæˆ", use_container_width=True, type="primary"):
        new_id = f"emp_{int(time.time())}"
        st.session_state.db.append({"id": new_id})
        st.session_state.current_id = new_id
        st.rerun()
    
    st.divider()
    st.subheader("ğŸ“‹ ãƒ‡ãƒ¼ã‚¿ä¸€è¦§")
    
    if st.session_state.db:
        for item in st.session_state.db:
            name = item.get("1", "æœªå…¥åŠ›")
            errors, warnings = validate(item, st.session_state.fields)
            icon = "âŒ" if errors else ("âš ï¸" if warnings else "âœ…")
            if st.button(f"{icon} {name}", key=item["id"], use_container_width=True):
                st.session_state.current_id = item["id"]
                st.rerun()
    else:
        st.info("ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“")
    
    st.divider()
    
    # ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
    if st.session_state.db:
        st.subheader("ğŸ“¤ ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ")
        json_str = json.dumps(st.session_state.db, ensure_ascii=False, indent=2)
        st.download_button("ğŸ’¾ JSON", json_str, f"data_{datetime.now().strftime('%Y%m%d')}.json", "application/json", use_container_width=True)
        
        # CSV
        export_data = []
        for item in st.session_state.db:
            row = {f["label"]: item.get(str(f["no"]), "") for f in st.session_state.fields}
            export_data.append(row)
        df = pd.DataFrame(export_data)
        csv = df.to_csv(index=False).encode('utf-8-sig')
        st.download_button("ğŸ“¥ CSV", csv, f"data_{datetime.now().strftime('%Y%m%d')}.csv", "text/csv", use_container_width=True)

# ãƒ¡ã‚¤ãƒ³ã‚¨ãƒªã‚¢
if st.session_state.current_id:
    current = [x for x in st.session_state.db if x["id"] == st.session_state.current_id][0]
    idx = st.session_state.db.index(current)
    
    st.title("é›‡ç”¨æ¡ä»¶å…¥åŠ›")
    st.subheader(f"ğŸ“ {current.get('1', 'æ–°è¦ä½œæˆ')}")
    
    # é€²æ—
    required = [f for f in st.session_state.fields if f.get("required")]
    filled = sum(1 for f in required if current.get(str(f["no"])))
    progress = filled / len(required) if required else 0
    
    col1, col2 = st.columns(2)
    with col1:
        st.metric("å…¥åŠ›é€²æ—", f"{int(progress*100)}%")
    with col2:
        st.metric("å¿…é ˆé …ç›®", f"{filled}/{len(required)}")
    
    st.progress(progress)
    st.divider()
    
    # ãƒšãƒ¼ã‚¸ã‚¿ãƒ–
    pages = sorted(set(f["page"] for f in st.session_state.fields))
    tabs = st.tabs([f"ãƒšãƒ¼ã‚¸ {p}" for p in pages])
    
    for i, page_num in enumerate(pages):
        with tabs[i]:
            page_fields = [f for f in st.session_state.fields if f["page"] == page_num]
            
            for j in range(0, len(page_fields), 2):
                cols = st.columns(2)
                for k in range(2):
                    if j+k < len(page_fields):
                        f = page_fields[j+k]
                        fid = str(f["no"])
                        label = f"ğŸ”´ {f['label']}" if f.get("required") else f["label"]
                        
                        with cols[k]:
                            if f["type"] == "number":
                                val = float(current.get(fid, 0))
                                new_val = st.number_input(label, value=val, key=f"{current['id']}_{fid}")
                                current[fid] = new_val
                            elif f["type"] == "select":
                                opts = [""] + f.get("options", [])
                                val = current.get(fid, "")
                                idx_sel = opts.index(val) if val in opts else 0
                                new_val = st.selectbox(label, opts, index=idx_sel, key=f"{current['id']}_{fid}")
                                current[fid] = new_val
                            elif f["type"] == "date":
                                val = current.get(fid, "")
                                new_val = st.text_input(label, value=val, key=f"{current['id']}_{fid}", placeholder="YYYY-MM-DD")
                                current[fid] = new_val
                            else:
                                val = current.get(fid, "")
                                new_val = st.text_input(label, value=val, key=f"{current['id']}_{fid}")
                                current[fid] = new_val
    
    st.session_state.db[st.session_state.db.index(current)] = current
    
    st.divider()
    
    # ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
    st.subheader("ğŸ“Š ãƒã‚§ãƒƒã‚¯çµæœ")
    errors, warnings = validate(current, st.session_state.fields)
    
    col1, col2 = st.columns(2)
    with col1:
        if errors:
            for e in errors:
                st.error(e)
        else:
            st.success("âœ… ã‚¨ãƒ©ãƒ¼ãªã—")
    with col2:
        if warnings:
            for w in warnings:
                st.warning(w)
        else:
            st.success("âœ… è­¦å‘Šãªã—")
    
    if not errors and not warnings:
        st.balloons()
    
    st.divider()
    
    # æ“ä½œãƒœã‚¿ãƒ³
    col1, col2 = st.columns(2)
    with col1:
        if st.button("ğŸ—‘ï¸ å‰Šé™¤", use_container_width=True):
            st.session_state.db.pop(st.session_state.db.index(current))
            st.session_state.current_id = None
            st.rerun()
    with col2:
        if st.button("ğŸ“‹ è¤‡è£½", use_container_width=True):
            new_id = f"emp_{int(time.time())}"
            dup = current.copy()
            dup["id"] = new_id
            dup["1"] = f"{dup.get('1', 'æœªå…¥åŠ›')} (ã‚³ãƒ”ãƒ¼)"
            st.session_state.db.append(dup)
            st.session_state.current_id = new_id
            st.rerun()
else:
    st.title("é›‡ç”¨æ¡ä»¶ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ  Pro")
    st.write("å·¦ã®ã‚µã‚¤ãƒ‰ãƒãƒ¼ã‹ã‚‰ã€Œæ–°è¦ä½œæˆã€ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦é–‹å§‹ã—ã¦ãã ã•ã„")
    st.divider()
    st.write("### ğŸ’¡ ä¸»ãªæ©Ÿèƒ½")
    st.write("- ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³")
    st.write("- CSV/JSONã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ")
    st.write("- æœ€ä½è³ƒé‡‘ãƒã‚§ãƒƒã‚¯")
    st.write("- åŠ´åƒåŸºæº–æ³•ãƒã‚§ãƒƒã‚¯")
`
                            }
                        },
                        document.getElementById("root")
                    );
                    
                    setTimeout(function() {
                        document.getElementById('loading').style.display = 'none';
                        var tip = document.getElementById('fullscreen-tip');
                        if (!localStorage.getItem('tip_shown')) {
                            tip.style.display = 'block';
                            setTimeout(function() { tip.style.display = 'none'; }, 10000);
                            localStorage.setItem('tip_shown', 'true');
                        }
                    }, 2000);
                } catch(e) {
                    document.getElementById('loading').innerHTML = '<div style="color:white;text-align:center;"><h2>ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</h2><p>' + e.message + '</p><button onclick="location.reload()" style="margin-top:20px;padding:10px 20px;font-size:16px;cursor:pointer;">å†èª­ã¿è¾¼ã¿</button></div>';
                }
            }, 500);
        });
    </script>
</body>
</html>